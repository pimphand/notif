name: Deploy Rust App

on:
  push:
    branches:
      - makan

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.SSH_PATH }}
            git pull origin makan
            cargo build --release
            pm2 restart 0
    # Kirim log/notifikasi ke Telegram channel setelah deploy (sukses atau gagal).
    # Required secret: TELEGRAM_BOT_TOKEN. Bot harus jadi admin channel @logConnectIndonesia.
    notify-telegram:
      name: Notify Telegram
      runs-on: ubuntu-latest
      needs: deploy
      if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'failure')
      steps:
        - name: Send deploy log to Telegram
          env:
            TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REF_NAME: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG_RAW: ${{ github.event.head_commit.message }}
          run: |
          if [ "${DEPLOY_RESULT}" = "success" ]; then
            STATUS="✅ Berhasil"
          else
            STATUS="❌ Gagal"
          fi

          # Sanitasi commit message (aman untuk tanda kutip/backtick/single-quote & newline)
          COMMIT_MSG="$(printf '%s' "${COMMIT_MSG_RAW}" \
            | head -c 200 \
            | tr '\n' ' ' \
            | sed -e 's/["`]/ /g' -e "s/'/ /g")"

          TEXT="$(cat <<EOF
ConnectID — Deploy ${STATUS}
Branch: ${REF_NAME}
Commit: ${COMMIT_MSG}
Oleh: ${ACTOR}
Log: ${RUN_URL}
EOF
)"

          curl -fsS -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=@logConnectIndonesia" \
              -d "disable_web_page_preview=true" \
              --data-urlencode "text=${TEXT}"
